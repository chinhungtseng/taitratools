load_all()
rpt_mof_summary_dev("2019-01", "2019-02", industry_type = "industry21", destdir = NULL)
document()
rpt_mof_summary_dev("2019-01", "2019-02", industry_type = "industry21", destdir = NULL)
load_all()
rpt_mof_summary_dev("2019-01", "2019-02", industry_type = "industry21", destdir = NULL)
validate_tt_read_mof
document()
load_all()
rpt_mof_summary_dev("2019-01", "2019-02", industry_type = "industry21", destdir = NULL)
fun <- function(start_date, end_date, period = 3, ports = "export", money = "usd", dep_month_cols = TRUE) {
tt_vroom_mof(start_date, end_date, period = period, direct = ports, money = money, dep_month_cols = TRUE)
}
fun("2019-01", "2019-02", ports = "export", money = "jpd")
fun("2019-01", "2019-02", ports = "export", money = "usd")
rpt_mof_summary_dev("2019-01", "2019-02", industry_type = "industry21", destdir = NULL)
load_all()
rpt_mof_summary_dev("2019-01", "2019-02", industry_type = "industry21", destdir = NULL)
load_all()
rpt_mof_summary_dev("2019-01", "2019-02", industry_type = "industry21", destdir = NULL)
summary.default()
summary.default
document()
summary.default
document()
check()
install()
build()
tt_parse_hscode
load_all()
tt_parse_hscode
library(taitratools)
tt_ls()
# Default is `export` and `usd`
sample1 <- tt_read_mof("2019-01", "2019-02", period = 1, direct = "export", money = "usd", dep_month_cols = TRUE)
head(sample1)
# Default is `export` and `usd`
sample1 <- tt_vroom_mof("2019-01", "2019-02", period = 1, direct = "export", money = "usd", dep_month_cols = TRUE)
head(sample1)
mof_data <- tt_vroom_mof("2019-01", "2019-02", period = 1, dep_month_cols = TRUE)
mof_data
mof_data_with_bind_industry <- mof_data %>% tt_bind_industry(sub = 8, col_more = TRUE, industry_type = "industry21")
str(mof_data_with_bind_industry)
unique(mof_data_with_bind_industry$industry)
mof_data
mof_data_with_industry_grouped_sum <- mof_data %>% tt_industry_grouped_sum(industry_type = "industry21", sub = 6, verbose = FALSE)
mof_data_with_industry_grouped_sum
mof_data_with_area <- mof_data %>% tt_bind_area()
mof_data_with_area
mof_data
tt_bind_area
mof_data_with_industry_grouped_sum
mof_data_with_area <- mof_data_with_industry_grouped_sum %>% tt_bind_area()
mof_data_with_industry_grouped_sum
mof_data_with_area <- mof_data_with_industry_grouped_sum$data %>% tt_bind_area()
mof_data_with_area
mof_data_with_area
mof_data_with_industry_grouped_sum$data %>% tt_append_area()
mof_data_with_industry_grouped_sum$data %>% tt_append_global()
mof_industry_data <- mof_data %>%
tt_industry_grouped_sum(industry_type = "industry21", sub = 6, verbose = FALSE) %>%
mof_data
knitr::opts_chunk$set(
collapse = TRUE,
comment = "#>",
fig.path = "man/figures/README-",
out.width = "100%"
)
library(taitratools)
tt_ls()
path <- tt_get_path("PATH_AREA")
path
area_tbl <- tt_read_table(path)
head(area_tbl)
# Default is `export` and `usd`
mof_data <- tt_vroom_mof("2019-01", "2019-02", period = 1, direct = "export", money = "usd", dep_month_cols = TRUE)
head(mof_data)
# industry_type => "all_industry", "industry21", "version1", "version2"
mof_data %>%
tt_bind_industry(sub = 8, col_more = TRUE, industry_type = "industry21", verbose = FALSE) %>%
head(5)
mof_industry_data <- mof_data %>%
tt_industry_grouped_sum(industry_type = "industry21", sub = 6, verbose = FALSE)
str(mof_industry_data)
head(mof_industry_data$data, 5)
mof_industry_data$data %>% tt_bind_area() %>% head(5)
mof_industry_data$data %>% tt_append_area() %>% head(5)
mof_industry_data$data %>% tt_append_global() %>% head(5)
mof_data %>% tt_grouped_sum()
mof_data
tt_grouped_sum
mof_data
mof_data %>% tt_grouped_sum(country, year, by = "value")
mof_data %>% tt_grouped_sum(country, year, by = "value")
mof_data %>% tt_grouped_sum(country, year, by = "weight") %>% head(5)
mof_data %>% tt_grouped_sum(year, month, by = "weight") %>% head(5)
mof_data %>%
tt_bind_industry(industry_type = "industry21", verbose = FALSE) %>%
tt_grouped_sum(country, year, by = "count") %>% head(5)
mof_data %>%
tt_bind_industry(industry_type = "industry21", verbose = FALSE) %>%
tt_grouped_sum(industry, country, year, by = "count") %>% head(5)
mof_data %>% tt_grouped_sum(year, month, by = "count") %>% head(5)
spread
tidyr::spread
?tidyr::spread
mof_data
mof_data %>% tt_grouped_sum(country, year, by = "value")
mof_data %>% tt_grouped_sum(country, year, by = "value") %>% tidyr::spread(year, value)
mof_data %>% tt_grouped_sum(country, year, by = "value") %>% tidyr::spread(year, value, fill = 0)
tidyr::spread
load_all()
# TODO Adding some common
getsourcepath <- function() {
tmp_path <- readxl::read_xlsx("inst/extdata/tt_source_path.xlsx")
.tt_source_path <- as.list(tmp_path$path)
names(.tt_source_path) <- tmp_path$name
save(.tt_source_path, file = "R/sysdata.rda", compress='xz')
}
tt_update_data <- function() {
# tt_source_path data -------------------------
tmp_path <- readxl::read_xlsx("inst/extdata/tt_source_path.xlsx")
.tt_source_path <- as.list(tmp_path$path)
names(.tt_source_path) <- tmp_path$name
# industry data -----------------------------
.industry_tbl <- tt_read_table(tt_get_path("PATH_INDUSTRY")) %>%
dplyr::mutate_at(dplyr::vars("reports_version_industry21", "reports_version_1", "reports_version_2"), list(~ tidyr::replace_na(., 0)))
.industry_tbl_en <- rlang::set_names(.industry_tbl, c("index", "type", "major", "minor", "hscode6", "hscode11", "hscode_dights",
"hscode", "industry", "reports_version_1", "reports_version_1_order", "reports_version_2",
"reports_version_2_order", "reports_version_2_ind_name", "reports_version_industry21", "reports_version_industry21_order"))
# industry21 data -----------------------------
.tt_ind21_list <- .industry_tbl[.industry_tbl[["reports_version_industry21"]] == 1, ][["\u7DE8\u865F"]]
.tt_ind21_tbl <- .industry_tbl[.industry_tbl[["\u7DE8\u865F"]] %in% .tt_ind21_list, ][c("\u7DE8\u865F", "industry", "reports_version_industry21_order")]
.tt_ind21_tbl_en <- .industry_tbl_en[.industry_tbl_en[["index"]] %in% .tt_ind21_list, ][c("index", "industry", "reports_version_industry21_order")]
# industry version 1 data -----------------------------
.tt_ind_list_verion_1 <- .industry_tbl[.industry_tbl[["reports_version_1"]] == 1, ][["\u7DE8\u865F"]]
.tt_ind_verion_1_tbl <- .industry_tbl[.industry_tbl[["\u7DE8\u865F"]] %in% .tt_ind_list_verion_1, ][c("\u7DE8\u865F", "industry", "reports_version_1_order")]
.tt_ind_verion_1_tbl_en <- .industry_tbl_en[.industry_tbl_en[["index"]] %in% .tt_ind_list_verion_1, ][c("index", "industry", "reports_version_1_order")]
# industry version 2 data -----------------------------
.tt_ind_list_verion_2 <- .industry_tbl[.industry_tbl[["reports_version_2"]] == 1, ][["\u7DE8\u865F"]]
.tt_ind_verion_2_tbl <- .industry_tbl[.industry_tbl[["\u7DE8\u865F"]] %in% .tt_ind_list_verion_2, ][c("\u7DE8\u865F", "industry", "reports_version_2_order")]
.tt_ind_verion_2_tbl_en <- .industry_tbl_en[.industry_tbl_en[["index"]] %in% .tt_ind_list_verion_2, ][c("index", "industry", "reports_version_2_order")]
# full hsocde data -----------------------------
.full_hscode_tbl <- tt_read_table(tt_get_path("PATH_FULL_HSCODE"))
tmp <- lapply(list(1:2, 3:4, 5:6, 7:8, 9:10), function(x) {
tmp <- unique(.full_hscode_tbl[x])
names(tmp) <- c("hscode", "hscode_cn")
tmp
})
.full_hscode_tbl <- Reduce(rbind, tmp)
# area data -------------------------------------
.area_tbl <- tt_read_table(tt_get_path("PATH_AREA"))
.area_tbl[.area_tbl$areaName == "全球", ][["countryName"]] <- "[\\w\\W]+"
# country name data -----------------------------
.country_ref_list <- readxl::read_xlsx("//172.26.1.102/dstore/重要資料/國家中英文對照.xlsx", skip = 1)
name_var <- c(
"name_ch",                                         # chinese name
paste0("mof.",         c("name", "code", "area")), # MOF
paste0("itc.",         c("name", "code")),         # ITC
paste0("world_bank.",  c("name", "code", "area")), # WORLD BANK
paste0("imf.",         c("name")),                 # IMF
paste0("oxford.",      c("name")),                 # OXFORD
paste0("un_comtrade.", c("name", "code", "iso")),  # UN COMTRADE
paste0("gta.",         c("name")),                 # GTA
paste0("itc_tariff.",  c("name")),                 # ITC TARIFF
paste0("asean.",       c("name", "code")),         # ASEAN
"name_ch2"                                         # same as name_ch
)
names(.country_ref_list) <- name_var
.mof_export_usd_sample_data <- tt_vroom_mof("2019-01", "2019-02", period = 3, dep_month_cols = TRUE)
# save data ------------------------------------
save(
.tt_source_path, .industry_tbl, .industry_tbl_en,
.tt_ind21_tbl, .tt_ind21_tbl_en, .tt_ind21_list,
.tt_ind_verion_1_tbl_en, .tt_ind_list_verion_1,
.tt_ind_verion_2_tbl_en, .tt_ind_list_verion_2,
.full_hscode_tbl, .area_tbl, .country_ref_list,
.mof_export_usd_sample_data,
file = "R/sysdata.rda", compress='xz')
}
getsourcepath()
tt_update_data()
install()
biuld()
build()
load_all()
start_date <- "2019-12"
end_date <- "2019-12"
period = 3
sub_hs_digits <- 8
n = 3
country_list = NULL
direct = "export"
money = "usd"
industry_type = "all_industry"
destdir = "."
verbose = TRUE
stopifnot(validate_tt_read_mof(start_date, end_date, period))
if (!is.null(destdir)) {stopifnot(dir.exists(destdir))}
stopifnot(check_industry_type(industry_type))
if (money == "usd") {
currency <- "\u5343\u7f8e\u5143"
} else {
currency <- "\u5343\u81fa\u5e63"
}
if (direct == "export") {
port <- "\u51fa\u53e3\u984d"
} else {
port <- "\u9032\u53e3\u984d"
}
date_info <- tt_parse_date(start_date, end_date, period)
mof_rawdata <- tt_vroom_mof(start_date, end_date, period = period, direct = direct, money = money, dep_month_cols = TRUE)
mof_rawdata <- mof_rawdata %>%
tt_df_sub_hscode(end = sub_hs_digits) %>%
tt_bind_industry(sub = sub_hs_digits, industry_type = industry_type, verbose = verbose, col_more = TRUE)
mof_rawdata
# part 1 --------------------------------------------
tmp_data <- mof_rawdata %>%
tt_append_area() %>%
tt_spread_value(by = "year") %>%
dplyr::mutate(id = paste0(country, "-", industry))
tmp_data
tmp_data_by_id <- split(tmp_data, tmp_data$id)
tmp_data_by_id
.x <- tmp_data_by_id[[1]]
.x %>%
dplyr::filter(!!rlang::sym(date_info$start_year) != 0 & !!rlang::sym(date_info$last_year) != 0 )
.x
date_info$start_year
date_info$last_year
.x %>%
dplyr::filter(!!rlang::sym(date_info$start_year) != 0 & !!rlang::sym(date_info$last_year) != 0 ) %>%
dplyr::mutate(
difference = !!rlang::sym(date_info$start_year) - !!rlang::sym(date_info$last_year),
growth_rate = cal_growth_rate(!!rlang::sym(date_info$start_year), !!rlang::sym(date_info$last_year)),
share = cal_share(!!rlang::sym(date_info$start_year), sum(.[[date_info$start_year]])),
rank = rank(dplyr::desc(difference))
)
.x %>%
dplyr::filter(!!rlang::sym(date_info$start_year) != 0 & !!rlang::sym(date_info$last_year) != 0 )
.x %>%
dplyr::filter(!!rlang::sym(date_info$start_year) != 0)
.x %>%
dplyr::filter(!!rlang::sym(date_info$start_year) != 0) %>%
dplyr::mutate(
difference = !!rlang::sym(date_info$start_year) - !!rlang::sym(date_info$last_year),
growth_rate = cal_growth_rate(!!rlang::sym(date_info$start_year), !!rlang::sym(date_info$last_year)),
share = cal_share(!!rlang::sym(date_info$start_year), sum(.[[date_info$start_year]])),
rank = rank(dplyr::desc(difference))
)
.x %>%
dplyr::filter(!!rlang::sym(date_info$start_year) != 0) %>%
dplyr::mutate(
difference = !!rlang::sym(date_info$start_year) - !!rlang::sym(date_info$last_year),
growth_rate = cal_growth_rate(!!rlang::sym(date_info$start_year), !!rlang::sym(date_info$last_year)),
share = cal_share(!!rlang::sym(date_info$start_year), sum(.[[date_info$start_year]])),
rank = rank(dplyr::desc(difference))
) %>%
dplyr::arrange(dplyr::desc(difference)) %>%
tt_df_filter_top_and_bottom_n(n, difference) %>%
dplyr::mutate(sub_info = get_pn_label(difference, n = n))
tmp_data_by_id_info <- tmp_data_by_id %>%
purrr::map(~ {
.x %>%
dplyr::filter(!!rlang::sym(date_info$start_year) != 0) %>% #  & !!rlang::sym(date_info$last_year) != 0
dplyr::mutate(
difference = !!rlang::sym(date_info$start_year) - !!rlang::sym(date_info$last_year),
growth_rate = cal_growth_rate(!!rlang::sym(date_info$start_year), !!rlang::sym(date_info$last_year)),
share = cal_share(!!rlang::sym(date_info$start_year), sum(.[[date_info$start_year]])),
rank = rank(dplyr::desc(difference))
) %>%
dplyr::arrange(dplyr::desc(difference)) %>%
tt_df_filter_top_and_bottom_n(n, difference) %>%
dplyr::mutate(sub_info = get_pn_label(difference, n = n))
}) %>%
purrr::reduce(dplyr::bind_rows) %>%
tt_df_mutate_chinese_hscode() %>%
dplyr::mutate(info = paste0(
hscode, ",", hscode_ch, ",",
"\u51fa\u53e3\u984d:", !!rlang::sym(date_info$start_year), currency, ",",
"\u6210\u9577\u7387:", growth_rate, "%", ",",
"\u4f54\u6bd4:", share, "%", ",",
"\u5dee\u7570:", difference, currency
)) %>%
dplyr::select(id, info, sub_info) %>%
dplyr::filter(!is.na(sub_info)) %>%
tidyr::complete(id, sub_info) %>%
tidyr::spread(sub_info, info) %>%
tidyr::separate(id, into = c("country", "industry"), sep = "-") %>%
dplyr::select(country, industry, dplyr::contains("\u589e\u984d"), dplyr::contains("\u6e1b\u984d"))
tmp_data_by_id_info
View(tmp_data_by_id_info)
.x %>%
dplyr::filter(!!rlang::sym(date_info$start_year) != 0)
.x %>%
dplyr::filter(!!rlang::sym(date_info$start_year) != 0 |  !!rlang::sym(date_info$last_year) != 0 )
.x %>%
dplyr::filter(!!rlang::sym(date_info$start_year) == 0 & !!rlang::sym(date_info$last_year) == 0 )
.x %>%
dplyr::filter(!(!!rlang::sym(date_info$start_year) == 0 & !!rlang::sym(date_info$last_year) == 0))
# part 2 --------------------------------------------
mof_data_with_ind <- mof_rawdata %>%
dplyr::group_by(type, major, minor, industry, country, year) %>%
dplyr::summarise(value = sum(value)) %>% dplyr::ungroup()
mof_data_with_ind
mof_data_calculated <- mof_data_with_ind %>%
tt_append_area() %>%
tt_spread_value(by = "year") %>%
dplyr::mutate(
difference = !! rlang::sym(date_info$start_year) - !! rlang::sym(date_info$last_year),
growth_rate = cal_growth_rate(!! rlang::sym(date_info$start_year), !! rlang::sym(date_info$last_year)),
cagr = cal_cagr(!! rlang::sym(date_info$start_year), !! rlang::sym(date_info$end_year), period = period)
) %>%
dplyr::arrange(country) %>%
tidyr::gather("year", "value", date_info$years) %>%
dplyr::filter(year == date_info$start_year)
mof_data_calculated <- dplyr::left_join(
mof_data_calculated, tmp_data_by_id_info,
by = c("country", "industry")
)
if (!is.null(country_list)) {
mof_data_calculated <- mof_data_calculated %>% dplyr::filter(country %in% country_list)
}
col_label <- paste0(date_info$start_year, "\u5e74", date_info$start_month, "-", date_info$end_month, "\u6708")
chinese_column_names <- c(
"\u570b\u5bb6", "\u7522\u696d",
paste0(col_label, port, "(", currency, ")"),
paste0(col_label, "\u589e\u6e1b\u984d(", currency, ")"),
paste0(col_label, "\u51fa\u53e3\u6210\u9577\u7387(%)"),
paste0(col_label, period, "\u5e74\u51fa\u53e3\u8907\u5408\u6210\u9577\u7387(%)"),
"\u4f54\u6bd4(%)", names(tmp_data_by_id_info)[c(-1, -2)]
)
outputs <- mof_data_calculated %>%
split(.$country) %>%
purrr::map(~ {
tmp_data <- dplyr::mutate(.x, share = cal_share(value, tt_ext_world_value(.x, by_country = TRUE)))
if (contain_any_keywords(industry_type, "version1", "version2")) {
tmp_data <- tt_order_by_industry_for_reports(tmp_data, version = industry_type) %>%
dplyr::mutate(industry = tt_convert_industry_name(major, minor))
}
tmp_data %>%
dplyr::select(country, industry, value, difference, growth_rate,
cagr, share, dplyr::contains("\u589e\u984d"), dplyr::contains("\u6e1b\u984d")) %>%
rlang::set_names(chinese_column_names)
}) %>%
purrr::reduce(dplyr::bind_rows)
outputs
tmp_data_by_id %>%
purrr::map(~ {
.x %>%
dplyr::filter(!(!!rlang::sym(date_info$start_year) == 0 & !!rlang::sym(date_info$last_year) == 0)) %>%
dplyr::mutate(
difference = !!rlang::sym(date_info$start_year) - !!rlang::sym(date_info$last_year),
growth_rate = cal_growth_rate(!!rlang::sym(date_info$start_year), !!rlang::sym(date_info$last_year)),
share = cal_share(!!rlang::sym(date_info$start_year), sum(.[[date_info$start_year]])),
rank = rank(dplyr::desc(difference))
) %>%
dplyr::arrange(dplyr::desc(difference)) %>%
tt_df_filter_top_and_bottom_n(n, difference) %>%
dplyr::mutate(sub_info = get_pn_label(difference, n = n))
})
industry_type <- "industry21"
stopifnot(validate_tt_read_mof(start_date, end_date, period))
if (!is.null(destdir)) {stopifnot(dir.exists(destdir))}
stopifnot(check_industry_type(industry_type))
if (money == "usd") {
currency <- "\u5343\u7f8e\u5143"
} else {
currency <- "\u5343\u81fa\u5e63"
}
if (direct == "export") {
port <- "\u51fa\u53e3\u984d"
} else {
port <- "\u9032\u53e3\u984d"
}
date_info <- tt_parse_date(start_date, end_date, period)
mof_rawdata <- tt_vroom_mof(start_date, end_date, period = period, direct = direct, money = money, dep_month_cols = TRUE)
mof_rawdata <- tt_vroom_mof(start_date, end_date, period = period, direct = direct, money = money, dep_month_cols = TRUE)
mof_rawdata
mof_rawdata <- mof_rawdata %>%
tt_df_sub_hscode(end = sub_hs_digits) %>%
tt_bind_industry(sub = sub_hs_digits, industry_type = industry_type, verbose = verbose, col_more = TRUE)
# part 1 --------------------------------------------
tmp_data <- mof_rawdata %>%
tt_append_area() %>%
tt_spread_value(by = "year") %>%
dplyr::mutate(id = paste0(country, "-", industry))
tmp_data_by_id <- split(tmp_data, tmp_data$id)
.x <- tmp_data_by_id[[1]]
.x %>%
dplyr::filter(!(!!rlang::sym(date_info$start_year) == 0 & !!rlang::sym(date_info$last_year) == 0)) %>%
dplyr::mutate(
difference = !!rlang::sym(date_info$start_year) - !!rlang::sym(date_info$last_year),
growth_rate = cal_growth_rate(!!rlang::sym(date_info$start_year), !!rlang::sym(date_info$last_year)),
share = cal_share(!!rlang::sym(date_info$start_year), sum(.[[date_info$start_year]])),
rank = rank(dplyr::desc(difference))
) %>%
dplyr::arrange(dplyr::desc(difference)) %>%
tt_df_filter_top_and_bottom_n(n, difference) %>%
dplyr::mutate(sub_info = get_pn_label(difference, n = n))
tt_df_mutate_chinese_hscode
.x %>%
dplyr::filter(!(!!rlang::sym(date_info$start_year) == 0 & !!rlang::sym(date_info$last_year) == 0)) %>%
dplyr::mutate(
difference = !!rlang::sym(date_info$start_year) - !!rlang::sym(date_info$last_year),
growth_rate = cal_growth_rate(!!rlang::sym(date_info$start_year), !!rlang::sym(date_info$last_year)),
share = cal_share(!!rlang::sym(date_info$start_year), sum(.[[date_info$start_year]])),
rank = rank(dplyr::desc(difference))
) %>%
dplyr::arrange(dplyr::desc(difference)) %>%
tt_df_filter_top_and_bottom_n(n, difference) %>%
dplyr::mutate(sub_info = get_pn_label(difference, n = n)) %>%
tt_df_mutate_chinese_hscode() %>%
dplyr::mutate(info = paste0(
hscode, ",", hscode_ch, ",",
"\u51fa\u53e3\u984d:", !!rlang::sym(date_info$start_year), currency, ",",
"\u6210\u9577\u7387:", growth_rate, "%", ",",
"\u4f54\u6bd4:", share, "%", ",",
"\u5dee\u7570:", difference, currency
)) %>%
dplyr::select(id, info, sub_info) %>%
dplyr::filter(!is.na(sub_info)) %>%
tidyr::complete(id, sub_info) %>%
tidyr::spread(sub_info, info) %>%
tidyr::separate(id, into = c("country", "industry"), sep = "-") %>%
dplyr::select(country, industry, dplyr::contains("\u589e\u984d"), dplyr::contains("\u6e1b\u984d"))
tmp_data_by_id %>%
purrr::map(~ {
.x %>%
dplyr::filter(!(!!rlang::sym(date_info$start_year) == 0 & !!rlang::sym(date_info$last_year) == 0)) %>%
dplyr::mutate(
difference = !!rlang::sym(date_info$start_year) - !!rlang::sym(date_info$last_year),
growth_rate = cal_growth_rate(!!rlang::sym(date_info$start_year), !!rlang::sym(date_info$last_year)),
share = cal_share(!!rlang::sym(date_info$start_year), sum(.[[date_info$start_year]])),
rank = rank(dplyr::desc(difference))
) %>%
dplyr::arrange(dplyr::desc(difference)) %>%
tt_df_filter_top_and_bottom_n(n, difference) %>%
dplyr::mutate(sub_info = get_pn_label(difference, n = n)) %>%
tt_df_mutate_chinese_hscode() %>%
dplyr::mutate(info = paste0(
hscode, ",", hscode_ch, ",",
"\u51fa\u53e3\u984d:", !!rlang::sym(date_info$start_year), currency, ",",
"\u6210\u9577\u7387:", growth_rate, "%", ",",
"\u4f54\u6bd4:", share, "%", ",",
"\u5dee\u7570:", difference, currency
)) %>%
dplyr::select(id, info, sub_info) %>%
dplyr::filter(!is.na(sub_info)) %>%
tidyr::complete(id, sub_info) %>%
tidyr::spread(sub_info, info) %>%
tidyr::separate(id, into = c("country", "industry"), sep = "-") %>%
dplyr::select(country, industry, dplyr::contains("\u589e\u984d"), dplyr::contains("\u6e1b\u984d"))
})
.x %>%
dplyr::filter(!(!!rlang::sym(date_info$start_year) == 0 & !!rlang::sym(date_info$last_year) == 0)) %>%
dplyr::mutate(
difference = !!rlang::sym(date_info$start_year) - !!rlang::sym(date_info$last_year),
growth_rate = cal_growth_rate(!!rlang::sym(date_info$start_year), !!rlang::sym(date_info$last_year)),
share = cal_share(!!rlang::sym(date_info$start_year), sum(.[[date_info$start_year]])),
rank = rank(dplyr::desc(difference))
) %>%
dplyr::arrange(dplyr::desc(difference)) %>%
tt_df_filter_top_and_bottom_n(n, difference) %>%
dplyr::mutate(sub_info = get_pn_label(difference, n = n)) %>%
tt_df_mutate_chinese_hscode() %>%
dplyr::mutate(info = paste0(
hscode, ",", hscode_ch, ",",
"\u51fa\u53e3\u984d:", !!rlang::sym(date_info$start_year), currency, ",",
"\u6210\u9577\u7387:", growth_rate, "%", ",",
"\u4f54\u6bd4:", share, "%", ",",
"\u5dee\u7570:", difference, currency
)) %>%
dplyr::select(id, info, sub_info) %>%
dplyr::filter(!is.na(sub_info)) %>%
tidyr::complete(id, sub_info) %>%
tidyr::spread(sub_info, info) %>%
tidyr::separate(id, into = c("country", "industry"), sep = "-") %>%
dplyr::select(country, industry, dplyr::contains("\u589e\u984d"), dplyr::contains("\u6e1b\u984d"))
tmp_data_by_id
tmp_data_by_id %>%
purrr::map(~ {
.x %>%
dplyr::filter(!(!!rlang::sym(date_info$start_year) == 0 & !!rlang::sym(date_info$last_year) == 0)) %>%
dplyr::mutate(
difference = !!rlang::sym(date_info$start_year) - !!rlang::sym(date_info$last_year),
growth_rate = cal_growth_rate(!!rlang::sym(date_info$start_year), !!rlang::sym(date_info$last_year)),
share = cal_share(!!rlang::sym(date_info$start_year), sum(.[[date_info$start_year]])),
rank = rank(dplyr::desc(difference))
) %>%
dplyr::arrange(dplyr::desc(difference)) %>%
tt_df_filter_top_and_bottom_n(n, difference) %>%
dplyr::mutate(sub_info = get_pn_label(difference, n = n)) %>%
tt_df_mutate_chinese_hscode() %>%
dplyr::mutate(info = paste0(
hscode, ",", hscode_ch, ",",
"\u51fa\u53e3\u984d:", !!rlang::sym(date_info$start_year), currency, ",",
"\u6210\u9577\u7387:", growth_rate, "%", ",",
"\u4f54\u6bd4:", share, "%", ",",
"\u5dee\u7570:", difference, currency
)) %>%
dplyr::select(id, info, sub_info) %>%
dplyr::filter(!is.na(sub_info)) %>%
tidyr::complete(id, sub_info) %>%
tidyr::spread(sub_info, info) %>%
tidyr::separate(id, into = c("country", "industry"), sep = "-") %>%
dplyr::select(country, industry, dplyr::contains("\u589e\u984d"), dplyr::contains("\u6e1b\u984d"))
})
gc()
.x
install()
build()
