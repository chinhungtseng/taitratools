# area data -------------------------------------
.area_tbl <- tt_read_table(tt_get_path("PATH_AREA"))
.area_tbl[.area_tbl$areaName == "全球", ][["countryName"]] <- "[\\w\\W]+"
# country name data -----------------------------
.country_ref_list <- readxl::read_xlsx("//172.26.1.102/dstore/重要資料/國家中英文對照.xlsx", skip = 1)
name_var <- c(
"name_ch",                                         # chinese name
paste0("mof.",         c("name", "code", "area")), # MOF
paste0("itc.",         c("name", "code")),         # ITC
paste0("world_bank.",  c("name", "code", "area")), # WORLD BANK
paste0("imf.",         c("name")),                 # IMF
paste0("oxford.",      c("name")),                 # OXFORD
paste0("un_comtrade.", c("name", "code", "iso")),  # UN COMTRADE
paste0("gta.",         c("name")),                 # GTA
paste0("itc_tariff.",  c("name")),                 # ITC TARIFF
paste0("asean.",       c("name", "code")),         # ASEAN
"name_ch2"                                         # same as name_ch
)
names(.country_ref_list) <- name_var
.mof_export_usd_sample_data <- tt_vroom_mof("2019-01", "2019-02", period = 3, dep_month_cols = TRUE)
# save data ------------------------------------
save(
.tt_source_path, .industry_tbl, .industry_tbl_en,
.tt_ind21_tbl, .tt_ind21_tbl_en, .tt_ind21_list,
.tt_ind_verion_1_tbl_en, .tt_ind_list_verion_1,
.tt_ind_verion_2_tbl_en, .tt_ind_list_verion_2,
.full_hscode_tbl, .area_tbl, .country_ref_list,
.mof_export_usd_sample_data,
file = "R/sysdata.rda", compress='xz')
}
getsourcepath()
tt_update_data()
install()
build()
use_tidy_eval()
check()
group_by
library(tidyverse)
enquos
group_by
summarise
ungroup
check()
document()
check()
dpyr::group_by
dplyr::group_by
ddocument()
document()
check()
load_all()
sample_data <- .mof_export_usd_sample_data
grouped_sum(sample_data, year, country)
sample_data %>%
grouped_sum(data, year, country)
sample_data
sample_data %>%
grouped_sum(year, country)
sample_data
sample_data %>%
grouped_sum(year, country)
data <- sample_data %>%
grouped_sum(year, country)
data
grouped_sum
grouped_sum(data, year)
data %>%
grouped_sum(data, year) %>%
mutate(country = "\u5168\u7403")
data %>%
grouped_sum(year) %>%
mutate(country = "\u5168\u7403")
names(data)
col_order <- names(data)
col_order
data %>%
grouped_sum(year) %>%
mutate(country = "\u5168\u7403") %>%
select(col_order)
data %>%
grouped_sum(year) %>%
mutate(country = "\u5168\u7403") %>%
select(col_order) %>%
left_join(data)
data %>%
grouped_sum(year) %>%
mutate(country = "\u5168\u7403") %>%
select(col_order) %>%
bind_rows(data)
data %>%
grouped_sum(year) %>%
mutate(country = "\u5168\u7403") %>%
select(col_order) %>%
bind_rows(data)
data
sample_data
sample_data %>%
tt_bind_industry(ind21 = TRUE)
data <- sample_data %>%
tt_bind_industry(ind21 = TRUE) %>%
grouped_sum(year, country, industry)
data
col_order <- names(data)
col_order
col_names <- names(data)
col_names
stopifnot(c("country", "value") %in% col_names)
key_vars <- c("country", "value")
col_names <- names(data)
stopifnot(key_vars %in% col_names)
which(key_vars, col_names)
which(key_vars == col_names)
col_names %in% key_vars
col_names[col_names %in% key_vars]
group_vars <- col_names[col_names %in% key_vars]
group_vars
utils::as.roman
utils:::as.roman
utils:::.numeric2roman
match(key_vars, col_names)
%in%
`%in%`
match(key_vars, col_names)
col_names[match(key_vars, col_names)]
group_vars <- col_names[!match(key_vars, col_names)]
group_vars
match(key_vars, col_names)
col_names %in% key_vars
group_vars <- col_names[!(col_names %in% key_vars)]
group_vars
data %>%
grouped_sum(group_vars)
group_vars
data %>%
grouped_sum(sym(group_vars))
data
grouped_sum
data %>%
grouped_sum(expr(group_vars))
expr(group_vars)
expr(!!quo(group_vars))
expr(!!quos(group_vars))
group_vars
expr(!!sym(group_vars))
expr(!!enquos(group_vars))
expr(!!!enquos(group_vars))
expr(!!enquos(group_vars))
data %>%
grouped_sum(expr(!!enquos(group_vars)))
var(group_vars)
var
vars(group_vars)
is_quosure(group_vars)
is_quosure
is_quosures
group_vars
grouped_sum
group_vars <- rlang::enquos(col_names[!(col_names %in% key_vars)])
col_names[!(col_names %in% key_vars)]
rlang::enquos(col_names[!(col_names %in% key_vars)])
rlang::enquos(group_vars)
group_vars <- rlang::quos(col_names[!(col_names %in% key_vars)])
group_vars
data %>%
group_by(!!! group_vars)
group_vars <- col_names[!(col_names %in% key_vars)]
group_vars <- rlang::enquos(group_vars)
group_vars
data %>%
group_by(!!! group_vars)
sym(col_names[!(col_names %in% key_vars)])
vars(col_names[!(col_names %in% key_vars)])
quo(col_names[!(col_names %in% key_vars)])
syms(col_names[!(col_names %in% key_vars)])
group_vars <- syms(col_names[!(col_names %in% key_vars)])
group_vars
data %>%
group_by(!!group_vars)
data %>%
group_by(!!!group_vars)
data %>%
group_by(!!!group_vars) %>%
summarise(value = sum(value))
dplyr::group_by
syms
data %>%
dplyr::group_by(!!!group_vars) %>%
dplyr::summarise(value = sum(value)) %>%
dplyr::ungroup()
data %>%
dplyr::group_by(!!!group_vars) %>%
dplyr::summarise(value = sum(value)) %>%
dplyr::ungroup() %>%
mutate(country = "\u5168\u7403")
col_names
data %>%
dplyr::group_by(!!!group_vars) %>%
dplyr::summarise(value = sum(value)) %>%
dplyr::ungroup() %>%
mutate(country = "\u5168\u7403") %>%
select(col_names)
data %>%
dplyr::group_by(!!!group_vars) %>%
dplyr::summarise(value = sum(value)) %>%
dplyr::ungroup() %>%
mutate(country = "\u5168\u7403") %>%
select(col_names) %>%
bind_rows(data)
append_global <- function(data, ...) {
key_vars <- c("country", "value")
col_names <- names(data)
stopifnot(key_vars %in% col_names)
group_vars <- rlang::syms(col_names[!(col_names %in% key_vars)])
data %>%
dplyr::group_by(!!!group_vars) %>%
dplyr::summarise(value = sum(value)) %>%
dplyr::ungroup() %>%
mutate(country = "\u5168\u7403") %>%
select(col_names) %>%
bind_rows(data)
}
data
data %>% append_global
append_global <- function(data, ...) {
key_vars <- c("country", "value")
col_names <- names(data)
stopifnot(key_vars %in% col_names)
group_vars <- rlang::syms(col_names[!(col_names %in% key_vars)])
data %>%
dplyr::group_by(!!!group_vars) %>%
dplyr::summarise(value = sum(value)) %>%
dplyr::ungroup() %>%
mutate(country = "\u5168\u7403") %>%
select(col_names) %>%
bind_rows(data)
}
data
sample_data
data <- sample_data %>%
tt_bind_industry(ind21 = TRUE) %>%
grouped_sum(year, month country, industry)
data <- sample_data %>%
tt_bind_industry(ind21 = TRUE) %>%
grouped_sum(year, month, country, industry)
data
key_vars <- c("country", "value")
col_names <- names(data)
stopifnot(key_vars %in% col_names)
group_vars <- rlang::syms(col_names[!(col_names %in% key_vars)])
group_vars
data %>%
dplyr::group_by(!!!group_vars)
data %>%
dplyr::group_by(!!!group_vars) %>%
dplyr::summarise(value = sum(value)) %>%
dplyr::ungroup() %>%
mutate(country = "\u5168\u7403") %>%
select(col_names) %>%
bind_rows(data)
document()
ddocument()
document()
check()
mutate
select
bind_rows
ddocument()
document()
load_all()
mof_data <- taitratools:::.mof_export_usd_sample_data
mof_data
library(tidyverse)
mof_data %>%
tt_bind_industry(ind21 = TRUE) %>%
tt_grouped_sum(year, country, industry)
mof_data %>%
tt_bind_industry(ind21 = TRUE) %>%
tt_grouped_sum(year, country, industry) %>%
spread(year, value)
x <- mof_data
x
x <- mof_data %>%
tt_bind_industry(ind21 = TRUE) %>%
tt_grouped_sum(year, country, industry)
x %>%
dplyr::spread(year, value)
x %>%
dplyr::spread(year, value)
spread
x %>%
tidyr::spread(year, value)
x
col_nm <- names(x)
col_nm
by <- "year"
stopifnot(c(by, "value") %in% col_nm)
c(by, "value")
c(by, "value") %in% col_nm
any(c(by, "value") %in% col_nm)
by <- "test"
stopifnot(any(c(by, "value") %in% col_nm))
stopifnot(all(c(by, "value") %in% col_nm))
by <- "year"
x %>%
tidyr::spread(year, value)
year
x %>%
tidyr::spread(!! sym(by), value)
tidyr::spread(x, !! sym(by), value)
tmp <- tidyr::spread(x, !! sym(by), value)
tmp
x[[by]]
unique(x[[by]])
new_cols <- unique(x[[by]])
new_cols
tmp %>%
mutate_at(vars(new_cols), list(~ replace_na(., 0)))
replace_na
vars
mutate_at
tmp <- dplyr::mutate_at(
tmp,
dplyr::vars(new_cols), list(~ tidyr::replace_na(., 0))
)
tmp
tt_spread <- function(x, by, na2zero = TRUE) {
col_nm <- names(x)
stopifnot(all(c(by, "value") %in% col_nm))
new_cols <- unique(x[[by]])
tmp <- tidyr::spread(x, !! sym(by), value)
if (na2zero) {
tmp <- dplyr::mutate_at(
tmp,
dplyr::vars(new_cols), list(~ tidyr::replace_na(., 0))
)
}
tmp
}
x
x %>% tt_spread(by = "year")
x %>% tt_spread(by = "year", FALSE)
x %>% tt_spread(by = "year")
tt_spread_value <- function(x, by, na2zero = TRUE) {
col_nm <- names(x)
stopifnot(all(c(by, "value") %in% col_nm))
new_cols <- unique(x[[by]])
tmp <- tidyr::spread(x, !! sym(by), value)
if (na2zero) {
tmp <- dplyr::mutate_at(
tmp,
dplyr::vars(new_cols), list(~ tidyr::replace_na(., 0))
)
}
tmp
}
x %>% tt_spread_value(by = "year")
x %>% tt_spread_value(by = "country")
load_all()
mof_data
mof_data %>%
tt_bind_industry(ind21 = TRUE) %>%
tt_grouped_sum(year, country, industry)
mof_data %>%
tt_bind_industry(ind21 = TRUE) %>%
tt_grouped_sum(year, country, industry) %>%
tt_spread_value(by = "year")
document()
data <- mof_data %>%
tt_bind_industry(ind21 = TRUE) %>%
tt_grouped_sum(year, country, industry)
data
key_vars <- c("country", "value")
col_names <- names(data)
col_names
data$country
unique(data$country)
country_list <- unique(data$country)
"\u5168\u7403"
"\u5168\u7403" %in% "\u5168\u7403"
"\u5168\u7403" %in% country_list
grepl("美美|阿明", country_list)
any(grepl("美美|阿明", country_list))
any(grepl("香港|阿明", country_list))
any(grepl("世界|阿明", country_list))
any(grepl("美國|阿明", country_list))
str2regex(c("美國", "5j/ eji6"))
str2regex(c("美國", "中國大陸"))
str2regex(c("美國", "中國大陸"), end = "$")
str2regex(c("美國", "中國大陸"), start = "^", end = "$")
str2regex(c("\u5168\u7403", "world", "World"), start = "^", end = "$")
any(grepl(str2regex(c("\u5168\u7403", "world", "World"), start = "^", end = "$"), country_list))
str2regex(c("\u5168\u7403", "world", "World"), start = "^", end = "$")
contain_word <- any(grepl(
str2regex(c("\u5168\u7403", "world", "World"), start = "^", end = "$"),
country_list
))
contain_word
if (contain_word) {
stop("Data contains `World` already!", call. = FALSE)
}
if (TRUE) {
stop("Data contains `World` already!", call. = FALSE)
}
if (contain_word) {
stop("Data contains `World` already!", call. = FALSE)
}
document()
data
data %>%
tt_spread_value(by = "country")
data %>%
tt_spread_value(by = "year")
data %>%
tt_spread_value(by = "year") %>%
dplyr::mutate(
growth_rate = cal_growth_rate(`2019`, `2018`)
)
data
data %>%
tt_append_global()
data %>%
tt_append_global() %>%
tt_spread_value(by = "year") %>%
dplyr::mutate(
growth_rate = cal_growth_rate(`2019`, `2018`),
share = cal_share(`2019`, .[.$country == "全球", ][["2019"]])
)
data %>%
tt_append_global() %>%
tt_spread_value(by = "year") %>%
dplyr::mutate(
growth_rate = cal_growth_rate(`2019`, `2018`),
share = cal_share(`2019`, .[.$country == "全球" && .$industry == "全部產品_全部產品", ][["2019"]])
)
data %>%
tt_append_global() %>%
tt_spread_value(by = "year") %>%
dplyr::mutate(
growth_rate = cal_growth_rate(`2019`, `2018`),
share = cal_share(`2019`, .[.$country == "全球" & .$industry == "全部產品_全部產品", ][["2019"]])
)
data %>%
tt_append_global() %>%
tt_spread_value(by = "year") %>%
dplyr::mutate(
growth_rate = cal_growth_rate(`2019`, `2018`),
share = cal_share(`2019`, .[.$country == "全球" & .$industry == "全部產品_全部產品", ][["2019"]])
) %>%
dplyr::arrange(desc(2019))
data %>%
tt_append_global() %>%
tt_spread_value(by = "year") %>%
dplyr::mutate(
growth_rate = cal_growth_rate(`2019`, `2018`),
share = cal_share(`2019`, .[.$country == "全球" & .$industry == "全部產品_全部產品", ][["2019"]])
) %>%
dplyr::arrange(desc(`2019`))
data %>%
tt_append_global() %>%
tt_spread_value(by = "year")
data %>%
tt_append_global() %>%
tt_spread_value(by = "year") %>%
split($country)
data %>%
tt_append_global() %>%
tt_spread_value(by = "year") %>%
split(.$country)
data %>%
tt_append_global() %>%
tt_spread_value(by = "year") %>%
split(.$country) %>%
map(~ .x %>%
dplyr::mutate(
growth_rate = cal_growth_rate(`2019`, `2018`),
share = cal_share(`2019`, .[.$country == "全球" & .$industry == "全部產品_全部產品", ][["2019"]])
) %>%
dplyr::arrange(desc(`2019`))
)
data %>%
tt_append_global() %>%
tt_spread_value(by = "year") %>%
split(.$country) %>%
dplyr::mutate(
growth_rate = cal_growth_rate(`2019`, `2018`),
share = cal_share(`2019`, .[.$country == "全球" & .$industry == "全部產品_全部產品", ][["2019"]])
) %>%
dplyr::arrange(desc(`2019`))
data %>%
tt_append_global() %>%
tt_spread_value(by = "year") %>%
split(.$country) %>%
dplyr::mutate(
growth_rate = cal_growth_rate(`2019`, `2018`),
share = cal_share(`2019`, .[.$country == "全球" & .$industry == "全部產品_全部產品", ][["2019"]])
) %>%
dplyr::arrange(desc(`2019`))
data %>%
tt_append_global() %>%
tt_spread_value(by = "year") %>%
dplyr::mutate(
growth_rate = cal_growth_rate(`2019`, `2018`),
share = cal_share(`2019`, .[.$country == "全球" & .$industry == "全部產品_全部產品", ][["2019"]])
) %>%
dplyr::arrange(desc(`2019`))
rm(list = ls*)
rm(list = ls())
gc()
load_all()
document()
library(xlsx)
library(rJava)
